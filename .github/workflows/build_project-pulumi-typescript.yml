name: Build sample project based on pulumi-typescript RI package
on: 
  pull_request:
    branches:
      - "main"
    paths:
      - "samples/projects/pulumi-typescript/**"
      - ".github/workflows/build_project-pulumi-typescript.yml"
  push:
    branches:
      - "main"
    paths:
      - "samples/projects/pulumi-typescript/**"
      - ".github/workflows/build_project-pulumi-typescript.yml"


defaults:
  run:
    working-directory: samples/projects/pulumi-typescript

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build the sample infra project
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm i
      - name: Start LocalStack
        run: |
          pip install localstack                    # install LocalStack cli
          docker pull localstack/localstack         # Make sure to pull the latest version of the image
          localstack start -d                       # Start LocalStack in the background
          
          echo "Waiting for LocalStack startup..."  # Wait 30 seconds for the LocalStack container
          localstack wait -t 30                     # to become ready before timing out 
          echo "Startup complete"          
      - uses: pulumi/actions@v3
        with:
          command: preview
          stack-name: openfabr/localstack
          work-dir: samples/projects/pulumi-typescript     # Pulumi.localstack.yaml has `aws:endpoit` configured to the localstack endpoint
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_OPENFABRORG_ACCESS_TOKEN }}
